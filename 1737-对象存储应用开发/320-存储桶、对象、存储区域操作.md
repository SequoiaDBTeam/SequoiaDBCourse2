---
show: step
version: 1.0 
---

## 课程介绍

SequoiaS3 将 S3 接口中的区域、桶和对象映射为 SequoiaDB 中的集合空间，集合，记录和Lob，实现桶的增、删、查，对象的增、删、查，对象的版本管理，以及分段上传的能力，支持从 Amazon S3 或其他实现 S3 接口的存储服务平滑迁移到 SequoiaDB数据库。SequoiaS3支持绝大部分Amazon S3 接口。本节课程中将展示使用JAVA操作SequoiaS3的代码示例。

#### SequoiaS3 开发简介

SequoiaDB 巨杉数据库兼容 AWS S3 接口。本节课将通过AWS SDK为进行S3操作。

#### 实验流程简述：

- 用户通过 IDEA 编辑器编写 Java 源码
- 实验相关核心代码，可从文档中的代码示例粘贴到项目指定文件的 TODO 标记处
- 通过编译、运行 Java 代码，操作 SequoiaS3实例

![](https://doc.shiyanlou.com/courses/1736/1207281/7b1731fc121e3b460dcd9841eb0218a6-0)

#### 实验环境

课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎为 3.4 版本。IDEA 编辑器为 16.0 版本。JDK 为 1.8 版本。

## 打开项目

#### 打开 IDEA

打开 IDEA 代码开发工具。

![](https://doc.shiyanlou.com/courses/1736/1207281/06650396616c742995bb63fcf933fac5-0)

#### 打开项目

打开 object-java 项目。

![image-20200414091915064](https://doc.shiyanlou.com/courses/1737/1207281/79e3fad2d27f14cfcbc94eadd646d88d-0)

#### 打开 Package

打开 scdd.lesson2_s3client 包，在该packge中完成后续课程。

![image-20200414131257650](https://doc.shiyanlou.com/courses/1737/1207281/2704c658bcbc57b8a37cd154c49dcd65-0)

## 存储桶的创建和查询

存储桶是 Amazon S3 中用于存储对象的容器，每个对象都存在各自的存储桶中。本小节，将通过 Java 实现 S3 存储桶的创建和查询。

本小节所操作的类均在 bucket 包下。

![image-20200413151613583](https://doc.shiyanlou.com/courses/1737/1207281/94991f58a4e6423ab1f698e41ae91372-0)

#### 存储桶的创建

AWS S3 提供的有对集群中存储桶的创建接口**createBucket(String str)**,该接口在SequoiaS3 中同样适用，可以通过 S3 对象直接调用该接口，创建指定的存储桶。

1）双击打开 BucketUtil 类，在 putBucket() 函数中找到行**TODO  创建桶**。

![image-20200418180706814](https://doc.shiyanlou.com/courses/1737/1207281/2b0202c0237a0c77fa0ef2531704b33f-0)

将下方代码粘贴到 TODO ~ TODO END 区域内。

```java
    // Get the S3 connection and create a bucket
    AmazonS3 s3 = this.getS3();
    // Call the interface for creating a bucket
    s3.createBucket(bucketName);
```

#### 存储桶的查询

AWS S3 提供的有对集群中存储桶的查询接口**listBuckets()**，该接口在 SequoiaS3 中同样适用，可以通过 S3 对象直接调用该接口，获得集群中存储桶的信息。

1）双击打开 BucketUtil 类，找到 queryBucket() 函数中找到行**TODO  列出所有的桶**

![image-20200418181109454](https://doc.shiyanlou.com/courses/1737/1207281/cdebb43e19f4d9fcbf221c7da1a570d8-0)

2）将下方代码粘贴到 TODO ~ TODO END 区域内。

```java
    // List all current buckets
    AmazonS3 s3 = this.getS3();
    List<Bucket> buckets = s3.listBuckets();
    // Output the list length, which is the number of buckets
    System.out.println("bucket number:" + buckets.size());
    // Traverse to output the name and creation date of each bucket
    for (int i = 0; i < buckets.size(); i++) {
        Bucket bucket = buckets.get(i);
        System.out.println("bucketname:" + bucket.getName() +
                           ", date:" + bucket.getCreationDate());
    }
```

#### 执行代码

1）鼠标移动到屏幕左边 BucketTest 类，右键点击，出现如图所示的选项条，左键单击**Edit 'BucketTest'**选项

![image-20200413153213390](https://doc.shiyanlou.com/courses/1737/1207281/58264e941503fdd6893436261833bee5-0)

2）在出现下图所示界面后，将 **CreateAndQuery** 填入红框所选位置，然后点击 **OK** 按钮

![image-20200413153641068](https://doc.shiyanlou.com/courses/1737/1207281/3a7ef6652f1ef068daac78e2f34e9813-0)

3）鼠标移动到屏幕左边 BucketTest 类上，右键点击，出现如图所示的选项条，左键单击**Run 'BucketTest'**选项。

![image-20200413153900784](https://doc.shiyanlou.com/courses/1737/1207281/828c5a070d6e76c28205aa0eea9d7228-0)

4）在屏幕下方查看结果输出，enter 代表开始此项操作，exit 代表结束这项操作，两者中间是执行中的输出信息

![image-20200413160942187](https://doc.shiyanlou.com/courses/1737/1207281/e9fdb55388c750d477f64508e0d44c4e-0)



## 存储桶的删除和查询

存储桶是 Amazon S3中用于存储对象的容器，每个对象都存在各自的存储桶中。本小节将通过 Java 实现 S3 存储桶的删除和查询。

本小节所操作的类均在 bucket 包下。

![image-20200413222253840](https://doc.shiyanlou.com/courses/1737/1207281/047a8c9321fa360d2c11dd9017ea013b-0)

#### 存储桶的删除

AWS S3 提供的有对集群中存储桶的删除接口**deleteBucket(String str)**，该接口在SequoiaS3 中同样适用，可以通过 S3 对象直接调用该接口，删除指定的存储桶。

1）双击打开 BucketUtil 类，在 deleteBucket() 函数中找到行**TODO  删除指定的桶**

![image-20200418181233291](https://doc.shiyanlou.com/courses/1737/1207281/f1895c7da0ed94224ea29d379f5bee1e-0)

2）将下方代码粘贴到 TODO ~ TODO END 区域内。

```java
// Get the S3 connection, then delete the bucket
AmazonS3 s3 = this.getS3();
s3.deleteBucket(bucketName);
```

#### 存储桶的查询

此处查询代码复用上一节的查询代码

查询代码如图

![image-20200414132954061](https://doc.shiyanlou.com/courses/1737/1207281/cc603ba93c424a261325a3c95e27d140-0)

#### 执行代码

1）鼠标移动到屏幕左边 BucketTest 类，右键点击，出现如图所示的选项条，左键单击**Edit 'BucketTest'**选项

![image-20200413153213390](https://doc.shiyanlou.com/courses/1737/1207281/58264e941503fdd6893436261833bee5-0)

2）在出现下图所示界面后，将**DeleteAndQuery**填入红框所选位置，然后点击**OK**按钮

![image-20200413161921682](https://doc.shiyanlou.com/courses/1737/1207281/33edfb3a59943c54ba3aded2b59399bb-0)

3）鼠标移动到屏幕左边 BucketTest 类上，右键点击，出现如图所示的选项条，左键单击**Run 'BucketTest'**选项

![image-20200413153900784](https://doc.shiyanlou.com/courses/1737/1207281/828c5a070d6e76c28205aa0eea9d7228-0)

4）在屏幕下方查看结果输出，enter代表开始此项操作，exit代表结束这项操作，两者中间是执行中的输出信息

![image-20200413162152328](https://doc.shiyanlou.com/courses/1737/1207281/8a7ac9c1abe482abdc4976457d26da40-0)



## 对象的创建和查询

对象是 S3 中存储的基本实体。对象由对象数据和元数据组成。数据部分对S3不透明，元数据是一组描述对象的名称-值对。本小节将通过 Java 实现 SequoiaS3 对象的创建和查询。

本小节所操作的类均在 object 包下。

![image-20200414135547052](https://doc.shiyanlou.com/courses/1737/1207281/32b7db5af4229794efe40d0dfbf035dc-0)

#### 对象的创建

AWS S3 提供的有对象的创建接口 **putObject(String var1, String var2, String var3)** ,该接口在 SequoiaS3 中同样适用，可以通过 S3 对象直接调用该接口，创建指定的对象。参数意义依次为存储桶名称、对象名称、要保存的内容。

1）双击打开 ObjectUtil类，找到 putObject() 函数内行**TODO 将指定内容保存为对象**。

![image-20200418181423281](https://doc.shiyanlou.com/courses/1737/1207281/67b963215417d2714488f6c4206b3cb0-0)

2）将下方代码粘贴到 TODO ~ TODO END 区域内。

```java
    // Get the S3 connection
    AmazonS3 s3 = this.getS3();
    // Create the object
    s3.putObject(bucketName, objectName, content);
```

#### 对象的查询

AWS S3 提供的有对象的创建接口 **listObjects(String var1)**,该接口在 SequoiaS3 中同样适用，可以通过 S3 对象直接调用该接口，查询指定存储桶内的对象。参数意义为要查询存储桶名称。

1）双击打开 ObjectUtil 类，找到 queryObject() 函数内行**TODO 查询指定桶内的对象**。

![image-20200418181521708](https://doc.shiyanlou.com/courses/1737/1207281/006757543f37a4fd8f30dd968e5cb254-0)

2）将下方代码粘贴到 TODO ~ TODO END 区域内。

```java
    // Call a method to get the list of objects in the specified bucket
    AmazonS3 s3 = this.getS3();
    ObjectListing objectListing = s3.listObjects(bucketName);
    List<S3ObjectSummary> objectList =  objectListing.getObjectSummaries();
    //Output the object information
    System.out.println("key count: "+objectList.size());
    for (int i = 0; i < objectList.size(); i++){
    System.out.println("key " +i + ": "+objectList.get(i).getKey());
    }
```

#### 执行代码

1）鼠标移动到屏幕左边 ObjectTest 类，右键点击，出现如图所示的选项条，左键单击**Edit 'ObjectTest'**选项

![image-20200413171223211](https://doc.shiyanlou.com/courses/1737/1207281/bd77e6d3594f5160b5a279adfa835285-0)

2）在出现下图所示界面后，将**CreateAndQuery**填入红框所选位置，然后点击**OK**按钮

![image-20200413171505818](https://doc.shiyanlou.com/courses/1737/1207281/ed8aee7ddc6a324fa55b0fd7330681f1-0)

3）鼠标移动到屏幕左边 ObjectTest 类上，右键点击，出现如图所示的选项条，左键单击**Run 'ObjectTest'**选项

![image-20200413172556987](https://doc.shiyanlou.com/courses/1737/1207281/035ec3a83fd4aa8b0af5e11525ddadfb-0)

4）在屏幕下方查看结果输出，enter代表开始此项操作，exit代表结束这项操作，两者中间是执行中的输出信息，key count代表个数，key * 为名称。从结果中可以看到listObject区域显示的key count为1，并且打印出来了集合的名字。

![image-20200413173036278](https://doc.shiyanlou.com/courses/1737/1207281/49cba0a791553236015d2162ee17414b-0)

## 对象的下载

对象是 S3 中存储的基本实体。对象由对象数据和元数据组成。数据部分对 S3 不透明，元数据是一组描述对象的名称-值对。本小节将通过 Java 实现 SequoiaS3 对象的下载。

本小节所操作的类均在object包下。

![image-20200413222948073](https://doc.shiyanlou.com/courses/1737/1207281/b3206e7d666a2ca50c24154371878f06-0)

#### 对象的下载

AWS S3提供的有对象的下载接口 **getObject(String var1, String var2)**,该接口在SequoiaS3 中同样适用，可以通过 S3 对象直接调用该接口，获取指定对象。参数意义依次为存储桶名称，对象名称。

1）双击打开 ObjectUtil 类，找到 getObject() 函数内行**TODO 获取指定对象**。

![image-20200418181641667](https://doc.shiyanlou.com/courses/1737/1207281/96846e26818ea79bd248888960e1367f-0)

2）将下方代码粘贴到 TODO ~ TODO END 区域内。

```java
    AmazonS3 s3 = this.getS3();
    // Get a reference to the specified object
    S3Object result = s3.getObject(bucketName,objectName);
    S3ObjectInputStream s3is = result.getObjectContent();
    File file = new File(objectName);
    //Print the path of file
    System.out.println("file path:" + file.getAbsolutePath());
    //Get file output stream to write file to disk
    FileOutputStream fos = new FileOutputStream(file);
    byte[] read_buf = new byte[1024 * 1024];
    int read_len;
    while ((read_len = s3is.read(read_buf)) > 0) {
    fos.write(read_buf, 0, read_len);
    }
    s3is.close();
    fos.close();
```

#### 执行代码

1）鼠标移动到屏幕左边 ObjectTest 类，右键点击，出现如图所示的选项条，左键单击**Edit 'ObjectTest'**选项

![image-20200413171223211](https://doc.shiyanlou.com/courses/1737/1207281/bd77e6d3594f5160b5a279adfa835285-0)

2）在出现下图所示界面后，将**Get**填入红框所选位置，然后点击**OK**按钮

![image-20200413173701126](https://doc.shiyanlou.com/courses/1737/1207281/54e68a1cf877e35adc3c64ff52d2086a-0)

3）鼠标移动到屏幕左边 ObjectTest 类上，右键点击，出现如图所示的选项条，左键单击**Run 'ObjectTest'**选项

![image-20200413172556987](https://doc.shiyanlou.com/courses/1737/1207281/035ec3a83fd4aa8b0af5e11525ddadfb-0)

4）在屏幕下方查看结果输出，enter代表开始此项操作，exit代表结束这项操作，两者中间是执行中的输出信息，file path是文件的保存路径。

![image-20200413173939953](https://doc.shiyanlou.com/courses/1737/1207281/ddf041c49a5262baf761dbb3055b6637-0)

## 对象的删除和查询

本小节所操作的类均在object包下。

![image-20200413222948073](https://doc.shiyanlou.com/courses/1737/1207281/66db8e8fb0ec521d3da555aa2a0c8282-0)

#### 对象的删除

AWS S3 提供的有对象的删除接口**deleteObject(String var1, String var2)**,该接口在SequoiaS3 中同样适用，可以通过 S3 对象直接调用该接口，删除指定对象。参数意义依次为存储桶名称，对象名称。

1）双击打开 ObjectUtil 类，找到deleteObject()函数内行**TODO 删除指定对象**。

![image-20200418181739138](https://doc.shiyanlou.com/courses/1737/1207281/61c06ba179bd53bf614a8feec6345306-0)

2）将下方代码粘贴到 TODO ~ TODO END 区域内。

```java
    AmazonS3 s3 = this.getS3();
    //After getting the S3 connection, call the method to delete the object.
    s3.deleteObject(bucketName, objectName);
```

#### 对象的查询

查询代码复用上一节的代码，代码如图所示

![image-20200413224000587](https://doc.shiyanlou.com/courses/1737/1207281/9e2be24ccea0e61f888dee9e15a519e0-0)

#### 执行代码

1）鼠标移动到屏幕左边 ObjectTest 类，右键点击，出现如图所示的选项条，左键单击**Edit 'ObjectTest'**选项

![image-20200413171223211](https://doc.shiyanlou.com/courses/1737/1207281/bd77e6d3594f5160b5a279adfa835285-0)

2）在出现下图所示界面后，将**DeleteAndQuery**填入红框所选位置，然后点击**OK**按钮

![image-20200413174355524](https://doc.shiyanlou.com/courses/1737/1207281/adfb632871035f66af48e1243eae21ad-0)

3）鼠标移动到屏幕左边 ObjectTest 类上，右键点击，出现如图所示的选项条，左键单击**Run 'ObjectTest'**选项

![image-20200413172556987](https://doc.shiyanlou.com/courses/1737/1207281/035ec3a83fd4aa8b0af5e11525ddadfb-0)

4）在屏幕下方查看结果输出，enter代表开始此项操作，exit代表结束这项操作，两者中间是执行中的输出信息，key count代表个数，key * 为名称。从结果中可以看到listObject区域显示的key count为0，代表对象已被删除。

![image-20200413175154266](https://doc.shiyanlou.com/courses/1737/1207281/533c6ea2527d63b387108a5cba3d4153-0)

## 区域的创建和查询

在AWS S3 中，区域是一个位置上的概念，可以选择地理区域供S3存储创建的存储桶。主要目的是优化延迟、尽可能减低成本或满足法规要求（当地用户的数据隐私）。在 SequoiaS3 中，淡化了位置方面的意义，区域代表的是对区域内数据存储位置进行配置。即指定集合空间的生成方式。而生成方式又分为指定模式和自动创建模式。

目前还没有现成的 Java API 可以直接对区域进行操作，本小节，通过 Java 代码构建 Post 请求实现对存储区域的操作。

本小节所操作的类均在 region 包下。

![image-20200413224218063](https://doc.shiyanlou.com/courses/1737/1207281/4e1dd368a8bd290b5e14bdf0c5190e84-0)

#### 区域的创建

对于区域操作， SequoiaS3 提供的有Rest接口，通过构建 CreateRegion 请求实现新建区域，同时还可以对同名区域进行更新配置。

1）双击打开 RegionUtil 类，找到 putRegion() 函数内行 **TODO 构建Post请求**

![image-20200418182011583](https://doc.shiyanlou.com/courses/1737/1207281/a6ed04f7f3c78f1147781c29180a94ce-0)

2）将下方代码粘贴到 TODO ~ TODO END 区域内。

```java
    //Operation type
    String action = "CreateRegion";
    //Build the url and it contains operation type and region name.
    String urlStr = "http://127.0.0.1:8002/region/?Action="+action+"&RegionName="+regionName;
    post = new HttpPost(urlStr);
    //Request the header to set the AccessKeyID and SecreatKeyID of S3
    post.setHeader("Authorization","AWS ABCDEFGHIJKLMNOPQRST:abcdefghijklmnopqrstuvwxyz0123456789ABCD");
    //The required parameters are in XML format, and they use dom4j tool to build.
    Document document = DocumentHelper.createDocument();
    //Set the master node
    Element root = document.addElement("RegionConfiguration");
    //Add the secondary node
    Element dataCSShardingType = root.addElement("DataCSShardingType");
    Element dataCLShardingType = root.addElement("DataCLShardingType");
    //Set the node value
    dataCSShardingType.addText("year");
    dataCLShardingType.addText("month");
    //Convert to the string with XML format
    String strXML = document.asXML();
    //Put parameters into the body of the Post request
    StringEntity postingString = new StringEntity(strXML,"utf-8");
    postingString.setContentType("application/xml");
    post.setEntity(postingString);
```

#### 区域的查询

对于区域操作，SequoiaS3提供的有Rest接口，通过构建ListRegions请求实现获得区域列表。该操作是查询出当前S3集群中区域的列表。

1）双击打开RegionUtil类，找到listRegion()函数中的行 **TODO 构建Post请求**

![image-20200418182107422](https://doc.shiyanlou.com/courses/1737/1207281/13cb2d6e4ec9e0dc20a1e4105701b1c0-0)

2）将下方代码粘贴到 TODO ~ TODO END 区域内。

```java
    //Operation type
    String action = "ListRegions";
    //Region name
    String regionName = "firstregion";
    //Build url, and it contains operation type and region name.
    String urlStr = "http://127.0.0.1:8002/region/?Action="+action;
    post = new HttpPost(urlStr);
    //Request the header to set the AccessKeyID and SecreatKeyID of S3
    post.setHeader("Authorization","AWS ABCDEFGHIJKLMNOPQRST:abcdefghijklmnopqrstuvwxyz0123456789ABCD");
```

#### 执行代码

1）鼠标移动到屏幕左边 RegionTest 类，右键点击，出现如图所示的选项条，左键单击**Edit 'RegionTest'**选项

![image-20200413225203160](https://doc.shiyanlou.com/courses/1737/1207281/41ed2527b349ab83657ff9c8c1fefd15-0)

2）在出现下图所示界面后，将**CreateAndQuery**填入红框所选位置，然后点击**OK**按钮

![image-20200413230441251](https://doc.shiyanlou.com/courses/1737/1207281/ed3e05f8188cf5895445b1c7ba693a2e-0)

3）鼠标移动到屏幕左边 RegionTest 类上，右键点击，出现如图所示的选项条，左键单击**Run 'RegionTest'**选项

![image-20200413230533932](https://doc.shiyanlou.com/courses/1737/1207281/63d4cc853bb297fe95c6c9f4cf33c9a4-0)

4）在屏幕下方查看结果输出，返回结果为xml格式。在创建firstregion区域后，查询S3实例内的区域列表，列出了刚刚创建的firstregion。

![image-20200414172719869](https://doc.shiyanlou.com/courses/1737/1207281/cc24c3ec20b872bd388a1b3d670bd181-0)

## 区域的删除和查询

#### 区域的删除

对于区域操作，SequoiaS3提供的有Rest接口，通过构建DeleteRegion请求实现删除指定区域。该操作是查询出当前S3集群中区域的列表。

1）双击打开RegionUtil类，找到deleteRegion()函数内的行 **TODO 构建Post请求**

![image-20200418182157607](https://doc.shiyanlou.com/courses/1737/1207281/5387828bfccdc2e870ad3aaaf1536774-0)

2）将下方代码粘贴到 TODO ~ TODO END 区域内。

```java
    //Operation type
    String action = "DeleteRegion";
    //Build url, and it contains operation type and region name.
    String urlStr = "http://127.0.0.1:8002/region/?Action="+action+"&RegionName="+regionName;
    post = new HttpPost(urlStr);
    //Request the header to set the AccessKeyID and SecreatKeyID of S3
    post.setHeader("Authorization","AWS ABCDEFGHIJKLMNOPQRST:abcdefghijklmnopqrstuvwxyz0123456789ABCD");
```

#### 区域的查询

查询代码复用上一节的代码，代码如图所示

![image-20200413234013981](https://doc.shiyanlou.com/courses/1737/1207281/368e5add2a4648beaaf00f0199134a28-0)

#### 执行代码

1）鼠标移动到屏幕左边RegionTest类，右键点击，出现如图所示的选项条，左键单击**Edit 'RegionTest'**选项

![image-20200413225203160](https://doc.shiyanlou.com/courses/1737/1207281/41ed2527b349ab83657ff9c8c1fefd15-0)

2）在出现下图所示界面后，将**DeleteAndQuery**填入红框所选位置，然后点击**OK**按钮

![image-20200413234145769](https://doc.shiyanlou.com/courses/1737/1207281/6aace689a3608716b4275d141fccaaca-0)

3）鼠标移动到屏幕左边RegionTest类上，右键点击，出现如图所示的选项条，左键单击**Run 'RegionTest'**选项

![image-20200413230533932](https://doc.shiyanlou.com/courses/1737/1207281/63d4cc853bb297fe95c6c9f4cf33c9a4-0)

4）在屏幕下方查看结果输出，返回结果为xml格式。可以看到，删除后在查询，并没有获得任何结果，说明firstregion已经被删除。

![image-20200414174317973](https://doc.shiyanlou.com/courses/1737/1207281/afcc02ff0aedd3d5e66a82fe09269a46-0)

