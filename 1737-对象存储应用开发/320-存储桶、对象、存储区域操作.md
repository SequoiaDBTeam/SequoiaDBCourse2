---
show: step
version: 1.0 
---


## 课程介绍

SequoiaS3 将 S3 接口中的区域、桶和对象映射为 SequoiaDB 中的集合空间，集合，记录和Lob，实现桶的增、删、查，对象的增、删、查，对象的版本管理，以及分段上传的能力，支持从 Amazon S3 或其他实现 S3 接口的存储服务平滑迁移到 SequoiaDB数据库。SequoiaS3支持绝大部分Amazon S3 接口。本节课程中将展示使用JAVA操作SequoiaS3的代码示例。

## 打开项目

#### 打开idea

打开idea代码开发工具

#### 打开java-object项目

打开java-object项目，在该课程中完成后续试验。

#### 打开scdd.lesson2_s3client packge，在该packge中完成后续课程。



## 存储桶

存储桶是Amazon S3中用于存储对象的容器，每个对象都存在各自的存储桶中。

本小节，将通过Java实现S3存储桶的创建、查询和删除。

双击打开bucket包，本小节所操作的类均在该包下

![image-20200413151306282](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-01.png)

#### 存储桶创建

Aws S3提供的有对集群中存储桶的创建接口**createBucket(String str)**,该接口在SequoiaS3中同样适用，可以通过S3对象直接调用该接口，创建指定的存储桶。

1）双击打开 BucketUtil类，找到行**TODO  创建桶**。

![image-20200413151613583](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-02.png)

将下方代码粘贴到TODO ~ TODO END位置区域

```java
    //获取s3连接并创建桶
    AmazonS3 s3 = this.getS3();
    //调用创建存储桶的接口
    s3.createBucket(bucketName);
```

#### 存储桶查询

Aws S3提供的有对集群中存储桶的查询接口**listBuckets()**，该接口在SequoiaS3中同样适用，可以通过S3对象直接调用该接口，获得集群中存储桶的信息。

1）双击打开BucketUtil类，找到行**TODO  列出所有的桶**

![image-20200413151828801](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-03.png)

2）将下方代码粘贴到TODO ~ TODO END位置区域

```java
    //列出当前所有的桶
    AmazonS3 s3 = this.getS3();
    List<Bucket> buckets = s3.listBuckets();
    //输出列表长度，也就是桶的数量
    System.out.println("bucket number:" + buckets.size());
    //遍历输出每个桶的名字和创建日期
    for (int i = 0; i < buckets.size(); i++) {
        Bucket bucket = buckets.get(i);
        System.out.println("bucketname:" + bucket.getName() +
                           ", date:" + bucket.getCreationDate());
    }
```

#### 存储桶删除

Aws S3提供的有对集群中存储桶的删除接口**deleteBucket(String str)**，该接口在SequoiaS3中同样适用，可以通过S3对象直接调用该接口，删除指定的存储桶。

1）双击打开BucketUtil类，找到行**TODO  删除指定的桶**

![image-20200413152450462](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-04.png)

2）将下方代码粘贴到TODO ~ TODO END位置区域

```java
//获取S3连接，然后删除桶
AmazonS3 s3 = this.getS3();
s3.deleteBucket(bucketName);
```

## 存储桶操作

在本小节中，将使用上一小节在**BucketUtil**类实现的函数测试存储桶的创建、查询和删除。

#### 存储桶的创建和查询

1）鼠标移动到屏幕左边BucketTest类，右键点击，出现如图所示的选项条，左键单击**Edit 'BucketTest'**选项

![image-20200413153213390](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-05.png)

2）在出现下图所示界面后，将**CreateAndQuery**填入红框所选位置，然后点击**OK**按钮

![image-20200413153641068](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-06.png)

3）鼠标移动到屏幕左边BucketTest类上，右键点击，出现如图所示的选项条，左键单击**Run 'BucketTest'**选项

![image-20200413153900784](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-07.png)

4）在屏幕下方查看结果输出，enter代表开始此项操作，exit代表结束这项操作，两者中间是执行中的输出信息

![image-20200413160942187](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-08.png)



#### 存储桶的删除和查询

1）鼠标移动到屏幕左边BucketTest类，右键点击，出现如图所示的选项条，左键单击**Edit 'BucketTest'**选项

![image-20200413153213390](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-05.png)

2）在出现下图所示界面后，将**DeleteAndQuery**填入红框所选位置，然后点击**OK**按钮

![image-20200413161921682](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-09.png)

3）鼠标移动到屏幕左边BucketTest类上，右键点击，出现如图所示的选项条，左键单击**Run 'BucketTest'**选项

![image-20200413153900784](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-07.png)

4）在屏幕下方查看结果输出，nter代表开始此项操作，exit代表结束这项操作，两者中间是执行中的输出信息

![image-20200413162152328](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-10.png)





## 对象

对象是S3中存储的基本实体。对象由对象数据和元数据组成。数据部分对S3不透明，元数据是一组描述对象的名称-值对。本小节，将通过Java实现SequoiaS3对象的创建、查询和删除。

双击打开object包，本小节所操作的类均在该包下

![image-20200413162824706](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-11.png)

#### 对象创建

Aws S3提供的有对象的创建接口**putObject(String var1, String var2, String var3)**,该接口在SequoiaS3中同样适用，可以通过S3对象直接调用该接口，创建指定的对象。参数意义依次为存储桶名称、对象名称、要保存的内容。

1）双击打开 ObjectUtil类，找到行**TODO 将指定内容保存为对象**。

![image-20200413163938724](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-12.png)

2）将下方代码粘贴到TODO ~ TODO END位置区域

```java
    //获取s3连接
    AmazonS3 s3 = this.getS3();
    //创建对象
    s3.putObject(bucketName, objectName, content);
```

#### 对象查询

Aws S3提供的有对象的创建接口**listObjects(String var1)**,该接口在SequoiaS3中同样适用，可以通过S3对象直接调用该接口，查询指定存储桶内的对象。参数意义为要查询存储桶名称。

1）双击打开 ObjectUtil类，找到行**TODO 查询指定桶内的对象**。

![image-20200413165016210](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-13.png)

2）将下方代码粘贴到TODO ~ TODO END位置区域

```java
    //调用方法获取指定桶内的对象列表
    AmazonS3 s3 = this.getS3();
    ObjectListing objectListing = s3.listObjects(bucketName);
    List<S3ObjectSummary> objectList =  objectListing.getObjectSummaries();
    //输出对象信息
    System.out.println("key count: "+objectList.size());
    for (int i = 0; i < objectList.size(); i++){
    System.out.println("key " +i + ": "+objectList.get(i).getKey());
    }
```

#### 对象下载

Aws S3提供的有对象的下载接口**getObject(String var1, String var2)**,该接口在SequoiaS3中同样适用，可以通过S3对象直接调用该接口，获取指定对象。参数意义依次为存储桶名称，对象名称。

1）双击打开 ObjectUtil类，找到行**TODO 获取指定对象**。

![image-20200413170124658](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-14.png)

2）将下方代码粘贴到TODO ~ TODO END位置区域

```
    AmazonS3 s3 = this.getS3();
    //获取指定对象的引用
    S3Object result = s3.getObject(bucketName,objectName);
    S3ObjectInputStream s3is = result.getObjectContent();
    File file = new File(objectName);
    //打印文件保存位置
    System.out.println("file path:" + file.getAbsolutePath());
    //获取文件输出流，以便向磁盘写入文件
    FileOutputStream fos = new FileOutputStream(file);
    byte[] read_buf = new byte[1024 * 1024];
    int read_len;
    while ((read_len = s3is.read(read_buf)) > 0) {
    fos.write(read_buf, 0, read_len);
    }
    s3is.close();
    fos.close();
```

#### 对象删除

Aws S3提供的有对象的删除接口**deleteObject(String var1, String var2)**,该接口在SequoiaS3中同样适用，可以通过S3对象直接调用该接口，删除指定对象。参数意义依次为存储桶名称，对象名称。

1）双击打开 ObjectUtil类，找到行**TODO 删除指定对象**。

![image-20200413170435379](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-15.png)

2）将下方代码粘贴到TODO ~ TODO END位置区域

```
    AmazonS3 s3 = this.getS3();
    //获取S3连接后，调用方法删除对象
    s3.deleteObject(bucketName, objectName);
```



## 对象操作

在本小节中，将使用上一小节在ObjectUtil类中实现的对象的创建、查询、获取和删除函数来操作对象。

#### 创建对象并查询

1）鼠标移动到屏幕左边ObjectTest类，右键点击，出现如图所示的选项条，左键单击**Edit 'ObjectTest'**选项

![image-20200413171223211](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-16.png)

2）在出现下图所示界面后，将**CreateAndQuery**填入红框所选位置，然后点击**OK**按钮

![image-20200413171505818](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-17.png)

3）鼠标移动到屏幕左边ObjectTest类上，右键点击，出现如图所示的选项条，左键单击**Run 'ObjectTest'**选项

![image-20200413172556987](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-18.png)

4）在屏幕下方查看结果输出，enter代表开始此项操作，exit代表结束这项操作，两者中间是执行中的输出信息，key count代表个数，key * 为名称。从结果中可以看到listObject区域显示的key count为1，并且打印出来了集合的名字。

![image-20200413173036278](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-19.png)



#### 下载对象

1）鼠标移动到屏幕左边ObjectTest类，右键点击，出现如图所示的选项条，左键单击**Edit 'ObjectTest'**选项

![image-20200413171223211](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-16.png)

2）在出现下图所示界面后，将**Get**填入红框所选位置，然后点击**OK**按钮

![image-20200413173701126](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-20.png)

3）鼠标移动到屏幕左边ObjectTest类上，右键点击，出现如图所示的选项条，左键单击**Run 'ObjectTest'**选项

![image-20200413172556987](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-18.png)

4）在屏幕下方查看结果输出，enter代表开始此项操作，exit代表结束这项操作，两者中间是执行中的输出信息，file path是文件的保存路径。

![image-20200413173939953](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-21.png)



#### 删除对象并查询

1）鼠标移动到屏幕左边ObjectTest类，右键点击，出现如图所示的选项条，左键单击**Edit 'ObjectTest'**选项

![image-20200413171223211](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-16.png)

2）在出现下图所示界面后，将**DeleteAndQuery**填入红框所选位置，然后点击**OK**按钮

![image-20200413174355524](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-22.png)

3）鼠标移动到屏幕左边ObjectTest类上，右键点击，出现如图所示的选项条，左键单击**Run 'ObjectTest'**选项

![image-20200413172556987](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-18.png)

4）在屏幕下方查看结果输出，enter代表开始此项操作，exit代表结束这项操作，两者中间是执行中的输出信息，key count代表个数，key * 为名称。从结果中可以看到listObject区域显示的key count为0，代表对象已被删除。

![image-20200413175154266](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1737-2-23.png)



## 存储区域操作

在Aws S3中，区域是一个位置上的概念，可以选择地理区域供S3存储创建的存储桶。主要目的是优化延迟、尽可能减低成本或满足法规要求（当地用户的数据隐私）。在SequoiaS3中，淡化了位置方面的意义，区域代表的是对区域内数据存储位置进行配置。即指定集合空间的生成方式。而生成方式又分为指定模式和自动创建模式。

目前还没有现成的Java api可以直接对区域进行操作，本小节，通过java代码构建post请求实现对存储区域的操作。

#### 区域创建

1）双击打开RegionUtil类，找到行 **TODO 构建Post请求**



2）将下方代码粘贴到TODO ~ TODO END位置区域

```
    HttpClient client = HttpClients.createDefault();
    //用字符串标识操作类型
    String action = "CreateRegion";
    //区域名称
    String regionName = "firstregion";
    //构建url，url包含操作类型和区域名称
    String urlStr = "http://127.0.0.1:8002/region/?Action="+action+"&RegionName="+regionName;
    HttpPost post = new HttpPost(urlStr);
    //请求header设置s3的AccessKeyID和SecreatKeyID
    post.setHeader("Authorization","AWS ABCDEFGHIJKLMNOPQRST:abcdefghijklmnopqrstuvwxyz0123456789ABCD");

    //把参数放进Post的body
    JSONObject object = new JSONObject();
    object.put("DataCSShardingType", "year");
    object.put("DataCLShardingType", "month");
    StringEntity postingString = new StringEntity(object.toString(),"utf-8");
    post.setEntity(postingString);
```



执行结果

![image-20200413203307267](E:\巨杉\s3\新建文件夹\2 存储桶对象存储区域操作.assets\1.png)

#### 构建url

双击打开Region类，找到引导行 **TODO 1 构建url**

引导行图示



将下方代码粘贴到引导行下方

```
        String action = "ListRegions";
        String urlStr = "http://192.168.81.111:8002/region/?Action="+action;
```



#### 写入参数

参数通过body传输

双击打开Region类，找到引导行 **TODO 2 写入参数**

引导行图示



将下方代码粘贴到引导行下方

```
        //以json格式生成参数
        JSONObject object = new JSONObject();
        object.put("DataCSShardingType", "year");
        object.put("DataCLShardingType", "month");
        object.put("DataDomain","domain1");
        object.put("MetaDomain","domain2");

        StringEntity postingString = new StringEntity(object.toString(),"utf-8");
        //将参数加入post请求中
        post.setEntity(postingString);
```



## 存储区域操作验证

1）填写运行参数

选择位于屏幕右上角的下拉符号，单击后选择第一个选项



出现如下界面，选择BucketTest，然后在**Program arguments**方框内输入 1 。



2）点击OK，保存参数



4）运行ObjectTest类，创建存储桶并查询验证。
