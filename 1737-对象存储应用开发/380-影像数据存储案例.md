---
show: step
version: 1.0 
---

## 课程介绍

在存储LOB时，只能oid才能对应到某一个LOB，不便于日常使用，在本小节提供一个将oid和文件的一些属性保存到另一张表的案例。

#### LOB 开发简介

SequoiaDB 巨杉数据库为应用提供通过 SDK 驱动进行数据库操作和集群操作的接口。

#### 实验流程简述：

- 用户通过 IDEA 编辑器编写 Java 源码
- 实验相关核心代码，可从文档中的代码示例粘贴到项目指定文件的 TODO 标记处
- 通过编译、运行 Java 代码，操作 SequoiaDB 数据库 JSON 实例

![](https://doc.shiyanlou.com/courses/1736/1207281/7b1731fc121e3b460dcd9841eb0218a6-0)

#### 实验环境

课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎为 3.4 版本。IDEA 编辑器为 16.0 版本。JDK 为 1.8 版本。

## 打开项目

#### 打开 IDEA

打开 IDEA 代码开发工具。

![](https://doc.shiyanlou.com/courses/1736/1207281/06650396616c742995bb63fcf933fac5-0)

#### 打开项目

打开object-java项目

![image-20200414091915064](https://doc.shiyanlou.com/courses/1737/1207281/79e3fad2d27f14cfcbc94eadd646d88d-0)

#### 打开 Package

打开lesson8_lobToSave包，在该Package完成后续课程

![image-20200415201811355](https://doc.shiyanlou.com/courses/1737/1207281/479e6039a7d4ebfb997c8f34a673be75-0)

## 存储表设计

#### 影像数据元数据存储设计

| 字段名    | 字段名注释                        |
| ----------- | ----------------------------- |
| filename | 文件名                        |
| lobid | lobid是文件上传后对应的唯一id |
| putdate | lob上传时间                   |
| filelength | 上传的文件大小            |

元数据包含文件名、文件的lobid、上传日期，大小 格式这些信息在上传lob时同步获得并写入到元数据表中.

#### 影像数据存储

所有影像数据通过lob上传，作为lob对象保存在集群中，lob的字段结构为集群自动生成。
| 字段名    | 字段名注释                        |
| ---------------- | ------------------------ |
| Size             | lob对象大小              |
| Oid              | 集群自动生成的唯一标识符 |
| CreateTime       | 创建时间                 |
| ModificationTime | 修改时间                 |
| Available        | 是否可用                 |

## 编写代码

在上传LOB的同时需要获取LOB的信息，然后把这些信息存储到表中。

#### 插入LOB

1）双击打开 LobSaveUtil 类，找到 putLob() 方法内行 **TODO  创建LOB**

![image-20200418190838662](https://doc.shiyanlou.com/courses/1737/1207281/b4d4333492e43a8f1b4552595d8f5db3-0)

2）将下方代码粘贴到 TODO ~ TODO END区域。

```java
    //Get the collection space object
    CollectionSpace cs = sequoiadb1.createCollectionSpace(csName);
    //Get the collection object
    DBCollection cl = cs.createCollection(clName);
    //Create the Lob
    DBLob lob = cl.createLob();
    //Call a function that inserts to the LOB metadata
    this.putLobData(csName,clName,lob,file);
    FileInputStream fileInputStream = new FileInputStream(file);
    //Write data to the Lob
    lob.write(fileInputStream);
    //Close the Lob
    lob.close();

```

#### 插入LOB元数据

1）双击打开 LobSaveUtil 类，找到 putLob() 方法内行 **TODO  插入LOB元数据**

![image-20200418190951214](https://doc.shiyanlou.com/courses/1737/1207281/7f74297596b645b8f74a853e0db8ce22-0)

2）将下方代码粘贴到 TODO ~ TODO END区域。

```java
    //Get the Lobid
    ObjectId id = lob.getID();
    String lobid = id.toString();
    //Get the file name to upload
    String fileName = file.getName();
    //Get the date of today
    Date date = this.getDate(0);
    //Get the file size
    long file_length = file.length();
    //Encapsulate metadata attributes
    BSONObject bsonObject = new BasicBSONObject();
    bsonObject.put("filename",fileName);
    bsonObject.put("lobId",lobid);
    bsonObject.put("putdate",date);
    bsonObject.put("file_length",file_length);
    //Get the collection object
    DBCollection collection = sequoiadb.getCollectionSpace(csName).getCollection(clName);
    //Insert data into the collection
    collection.insert(bsonObject);

```

#### 查询数据

同时查询插入的LOB元数据记录和LOB，观察元数据记录的 lobid 字段和 LOB 的 oid 是否一致

1）双击打开 LobSaveUtil 类，找到 queryData() 方法内行 **TODO  插入LOB元数据**

![image-20200418191035649](E:\巨杉\s3\新建文件夹\image2\8\380-03.png)

2）将下方代码粘贴到TODO ~ TODO END区域的第42行

```java
    //Get the collection object
    DBCollection collection = sequoiadb.getCollectionSpace(csName).getCollection(clName);
    BSONObject matcher = new BasicBSONObject();
    //Add search condition
    matcher.put("filename",fileName);
    //Get the date of yesterday
    Date date = this.getDate(-1);
    //Query files generated after yesterday
    matcher.put("putdate",new BasicBSONObject("$gt", date));
    //Execute query
    DBCursor cursor = collection.query(matcher,null,null,null);
    //Output query results
    while (cursor.hasNext()) {
        BSONObject record = cursor.getNext();
        System.out.println(record.toString());
    }
    //Query the LOB in collection
    LobUtil lobUtil = new LobUtil();
    lobUtil.listLob(csName,clName);
```

## 执行代码

1）鼠标移动到屏幕左边 LobSaveTest 类，右键点击，出现如图所示的选项条，左键单击**Edit 'LobSaveTest'**选项

![image-20200415131515336](https://doc.shiyanlou.com/courses/1737/1207281/e2a1692048267807a39834953bdb1dbd-0)

2）在出现下图所示界面后，将**PutAndQuery**填入红框所选位置，然后点击**OK**按钮

![image-20200415131553631](https://doc.shiyanlou.com/courses/1737/1207281/be4ee8d9c59eaaa8ef2c34ff77f1a465-0)

3）鼠标移动到屏幕左边LobSaveTest类上，右键点击，出现如图所示的选项条，左键单击**Run 'LobSaveTest'**选项

![image-20200415131801706](https://doc.shiyanlou.com/courses/1737/1207281/6355d5059b3cc350668732739a261fb6-0)

4）在屏幕下方查看结果输出，第一行为LOB元数据表的数据，第二行是查询得到的LOB信息，可以看到 lobid 和 Oid 相同，可以快捷的通过LOB元数据表查询已经存在的LOB。

![image-20200415131932971](https://doc.shiyanlou.com/courses/1737/1207281/68d64682920f676ad0e5a771e742b4ba-0)
