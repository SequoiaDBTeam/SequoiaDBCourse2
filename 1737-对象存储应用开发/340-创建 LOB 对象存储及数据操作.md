---
show: step
version: 1.0 
---

## 课程介绍

大对象（LOB）功能旨在突破 SequoiaDB 的单条记录最大长度为 16MB 的限制，为用户写入和读取更大型记录提供便利。LOB 记录的大小目前不受限制。

每一个 LOB 记录拥有一个 OID，通过指定集合及 OID 可以访问一条 LOB 记录。在非分区集合及哈希分区集合中均可使用 LOB 功能。集合间不共享 LOB 记录。当一个集合被删除时，其拥有的 LOB 记录自动删除。

LOB 记录的存储格式：



![LOB的记录格式](http://doc.sequoiadb.com/cn/index/Public/Home/images/304/data_model/lob.jpg)



每个 LOB 记录包含若干个分片。分片所占空间大小均为 LobPageSize（创建集合空间时指定，默认为 256 KB，请参考 [Sdb.createCS()](http://doc.sequoiadb.com/cn/SequoiaDB-cat_id-1432190773-edition_id-304)）。在哈希分区中，LOB 记录的每一个分片会被按照 OID 加分片序号分散存储在相应的分区组中。其哈希空间与所属集合的哈希空间相同。

目前 LOB 的存储格式为二进制类型。

#### LOB 开发简介

SequoiaDB 巨杉数据库为应用提供通过 SDK 驱动进行数据库操作和集群操作的接口。

#### 实验流程简述：

- 用户通过 IDEA 编辑器编写 Java 源码
- 实验相关核心代码，可从文档中的代码示例粘贴到项目指定文件的 TODO 标记处
- 通过编译、运行 Java 代码，操作 SequoiaDB 数据库 JSON 实例

![](https://doc.shiyanlou.com/courses/1736/1207281/7b1731fc121e3b460dcd9841eb0218a6-0)

#### 实验环境

课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎为 3.4 版本。IDEA 编辑器为 16.0 版本。JDK 为 1.8 版本。

## 打开项目

#### 打开 IDEA

打开 IDEA 代码开发工具。

![](https://doc.shiyanlou.com/courses/1736/1207281/06650396616c742995bb63fcf933fac5-0)

#### 打开项目

打开object-java项目。

![image-20200414091915064](https://doc.shiyanlou.com/courses/1737/1207281/8fae6ec098d2e1f9a431636f6f919ad8-0)

#### 打开 Package

打开 lesson4_lob 包，在该 Package 完成后续课程。

![image-20200422175841041](https://doc.shiyanlou.com/courses/1737/1207281/b4d00ade214624b962b1c83d220b4f68-0)

## 获得SequoiaDB连接

在使用 Java 开发 SequoiaDB 时，需要先连接到 SequoiaDB ，然后通过该连接对SequoiaDB 集群进行操作。

1）双击打开 LobUtil 类，找到行**TODO code1 获取sequoiadb连接**。

![image-20200422160621545](https://doc.shiyanlou.com/courses/1737/1207281/1db4b18544d5d4bf9a78390b5b90f51b-0)

2）将下方代码粘贴到 TODO ~ TODO END区域第60行。

```
/**
* @param addr
* @param port
* @param username
* @param password
*/
sequoiadb = new Sequoiadb("sdbserver1", 11810, "", "");
```



## Lob的创建和查询

#### 上传Lob

在 Java 中上传 LOB 是需要先创建一个LOB对象，然后通过LOB对象向集群中写入数据。

1）双击打开 LobUtil 类，在 putLob() 方法中找到行**TODO code2 创建Lob**。

![image-20200422160741561](https://doc.shiyanlou.com/courses/1737/1207281/62776ea456adf2fa8473d145bba104a0-0)

2）将下方代码粘贴到 TODO ~ TODO END区域。

```
//Get the collection space object
CollectionSpace cs = sequoiadb1.createCollectionSpace(csName);
//Get collection object
DBCollection cl = cs.createCollection(clName);

//Create the Lob
DBLob lob = cl.createLob();
ObjectId id = lob.getID();
//Print oid, and a unique oid will be generated when the Lob object is created
String s = id.toString();
fileInputStream = new FileInputStream(file);
//Write data to the Lob
lob.write(fileInputStream);
//Close the Lob
lob.close();
```

#### 查询Lob

SequoiaDB 在 DBCollection 类中提供了listLob()接口，可以获得指定集合内的LOB列表。

1）双击打开 LobUtil 类，在 listLob() 方法中找到行**TODO code3 查询Lob**。

![image-20200422160833940](https://doc.shiyanlou.com/courses/1737/1207281/0efebf0529b0827ecaf4244a80ee13ef-0)

2）将下方代码粘贴到 TODO ~ TODO END区域。

```
//Get the collection space object
CollectionSpace cs = sequoiadb1.getCollectionSpace(csName);
//Get collection object
DBCollection cl = cs.getCollection(clName);
//Get the list of Lob in the collection
DBCursor cursor = cl.listLobs();
try {
//Traverse the Lob list and output Lob information
while (cursor.hasNext()) {
BSONObject record = cursor.getNext();
System.out.println(record.toString());
}
} catch (Exception e) {
e.printStackTrace();
} finally {
cursor.close();
}
```

#### 执行代码

1）鼠标移动到屏幕左边 LobTest 类，右键点击，出现如图所示的选项条，左键单击**Edit 'LobTest'**选项。

![image-20200414113159226](https://doc.shiyanlou.com/courses/1737/1207281/0d127db63c7a98393f7cd1e874d9e6ff-0)

2）在出现下图所示界面后，将**CreateAndQuery**填入红框所选位置，然后点击**OK**按钮。

![image-20200414113245797](https://doc.shiyanlou.com/courses/1737/1207281/25ad403757af6f1d9ed80c9313bd3f0d-0)

3）鼠标移动到屏幕左边 LobTest 类上，右键点击，出现如图所示的选项条，左键单击**Run 'LobTest'**选项。

![image-20200414113756706](https://doc.shiyanlou.com/courses/1737/1207281/6e62e93ad5df294ba71ecb483c0650a8-0)

4）在屏幕下方查看结果输出，enter代表开始此项操作，exit代表结束这项操作，两者中间是执行中的输出信息。

![image-20200414113704578](https://doc.shiyanlou.com/courses/1737/1207281/74eb299764c0de29cd6fb41818496f2e-0)

5）保存oid

选中oid，右键点击屏幕，选择copy选项。

![image-20200414114705093](https://doc.shiyanlou.com/courses/1737/1207281/40e39616d12368a1a1eb3c05bc9974c7-0)

在第20行找到 openLob() 方法，将oid粘贴到第21行。

![image-20200418184605506](https://doc.shiyanlou.com/courses/1737/1207281/8c5b4f5b3fe1eaa880fc5b85e72fa0db-0)

## 下载Lob

#### 下载Lob

SequoiaDB 在 DBCollection 类中提供了openLob()接口，可以获得集合内的指定LOB的引用，然后读取LOB，通过文件输出流写入到本地。

1）双击打开 LobUtil类，在 getLob() 方法中找到行**TODO code4 下载Lob**。

![image-20200422160937330](https://doc.shiyanlou.com/courses/1737/1207281/0e5b2990947ffbe5bc2e92fdebea4ab4-0)

2）将下方代码粘贴到 TODO ~ TODO END区域。同时将上一小节获得的oid粘贴到下方代码的第二行的双引号内。

```
//Get the specified Lob object by oid
DBLob dbLob = cl.openLob(new ObjectId(""));
FileOutputStream fileOutputStream = null;
try {
//Get the file output stream, and set the file path and file name
fileOutputStream = new FileOutputStream(new File("/home/shiyanlou/Desktop/sequoiadb.txt"));
//Read the Lob and write to the local
dbLob.read(fileOutputStream);
} catch (FileNotFoundException e) {
e.printStackTrace();
}finally {
dbLob.close();
}
```

#### 执行代码

1）鼠标移动到屏幕左边 LobTest 类，右键点击，出现如图所示的选项条，左键单击**Edit 'LobTest'**选项。

![image-20200414113159226](https://doc.shiyanlou.com/courses/1737/1207281/0d127db63c7a98393f7cd1e874d9e6ff-0)

2）在出现下图所示界面后，将**Get**填入红框所选位置，然后点击**OK**按钮。

![image-20200414115558800](https://doc.shiyanlou.com/courses/1737/1207281/48cec080d262420bdcd7bf7f1e004c5b-0)

3）鼠标移动到屏幕左边 LobTest 类上，右键点击，出现如图所示的选项条，左键单击**Run 'LobTest'**选项。

![image-20200414113756706](https://doc.shiyanlou.com/courses/1737/1207281/6e62e93ad5df294ba71ecb483c0650a8-0)

4）在屏幕下方查看结果输出，enter代表开始此项操作，exit代表结束这项操作，两者中间是执行中的输出信息。

![image-20200414115646560](https://doc.shiyanlou.com/courses/1737/1207281/a41ce933f1712bc03d44ab2bbd12932b-0)

5）查看文件

该文件的下载保存路径为桌面，回到桌面查看文件是否存在。

![image-20200415210151444](https://doc.shiyanlou.com/courses/1737/1207281/9afcd214c3bb92f4cf73b046f1309f2d-0)

## Lob的删除和查询

#### 删除Lob

SequoiaDB 在 DBCollection 类中提供了removeLob()接口，传入要删除对象的oid就可以删除指定LOB。

1）双击打开 LobUtil 类，在 removeLob() 方法中找到行 **TODO code5 删除Lob**

![image-20200422161313244](https://doc.shiyanlou.com/courses/1737/1207281/d063116a6949def1c696daf354af3763-0)

2）将下方代码粘贴到 TODO ~ TODO END区域。并将上一步用到的oid再次粘贴到下方代码的最后一行的双引号内

```
//Get the collection space object
CollectionSpace cs = sequoiadb1.getCollectionSpace(csName);
//Get the collection object
DBCollection cl = cs.getCollection(clName);
//Delete the specified Lob
cl.removeLob(new ObjectId(""));
```

#### 查询Lob

查询功能的实现复用在Lob的创建和查询小节中实现的查询Lob功能。

代码如图

![image-20200414121546707](https://doc.shiyanlou.com/courses/1737/1207281/b2c74412acb454f0929ff114e55476c1-0)

#### 执行代码

1）鼠标移动到屏幕左边 LobTest 类，右键点击，出现如图所示的选项条，左键单击**Edit 'LobTest'**选项

![image-20200414113159226](https://doc.shiyanlou.com/courses/1737/1207281/0d127db63c7a98393f7cd1e874d9e6ff-0)

2）在出现下图所示界面后，将**DeleteAndQuery**填入红框所选位置，然后点击**OK**按钮

![1737-4-16](https://doc.shiyanlou.com/courses/1737/1207281/c8bf46336e8708c769e4d1f278905781-0)

3）鼠标移动到屏幕左边 LobTest 类上，右键点击，出现如图所示的选项条，左键单击**Run 'LobTest'**选项

![image-20200414113756706](https://doc.shiyanlou.com/courses/1737/1207281/6e62e93ad5df294ba71ecb483c0650a8-0)

4）在屏幕下方查看结果输出，enter代表开始此项操作，exit代表结束这项操作，两者中间是执行中的输出信息。可以看到query区域输出为空，代表唯一的lob已被从集合中删除。

![image-20200414122156166](https://doc.shiyanlou.com/courses/1737/1207281/a70e06945b1735444e9783513b88501a-0)

## 总结

在本节课中，我们学习到了使用Java API对Lob对象进行各种操作，但有的同学可能会发现，下载或删除lob时，只能通过oid进行，但我们日常更熟悉的是用文件名称来进行操作，在后面的课程中将会为此设计一套解决方案。
