---
show: step
version: 1.0 

---

## 课程介绍

本课程将带领您在已经部署 SequoiaDB 巨杉数据库引擎及创建了 MySQL 实例的环境中，熟悉MySQL的视图和触发器

#### 请点击右侧选择使用的实验环境

#### 实验环境

课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎以及 SequoiaSQL-MySQL 实例均为 3.4 版本。

#### 概述

**视图**

视图是虚拟的表。与包含数据的表不一样，视图只包含使用时动态检索数据的查询。

**触发器**

触发器是MySQL响应以下任意语句而
自动执行的一条MySQL语句（或位于BEGIN和END语句之间的一组语句） ：DELETE、INSERT、UPDATE

## 打开项目

#### 打开idea

打开idea代码开发工具

![1735-110-1.png](https://doc.shiyanlou.com/courses/1735/1207281/6f87a8c93937c3c51f6d4839559de710-0)

#### 打开SSQL-MySQL项目

打开SSQL-MySQL项目，在该课程中完成后续试验

![1735-110-13.png](https://doc.shiyanlou.com/courses/1735/1207281/40a9e7b6fbd5c3853dc09f69d0a06c86-0)

#### 打开lesson8_viewAndTrigger包

打开lesson8_viewAndTrigger packge，在该packge中完成后续课程。

![1735-180-1.png](https://doc.shiyanlou.com/courses/1735/1207281/be12989d771e7c9e6ec98542e8f2050b-0)

## 创建、删除、查看视图

视图是虚拟的表。与包含数据的表不一样，视图只包含使用时动态检索数据的查询

创建视图

```SQL
CREATE [OR REPLACE] VIEW 视图名(列1，列2...)

AS SELECT (列1，列2...)

FROM ...;

[WITH [CASCADED|LOCAL] CHECK OPTION]
```

删除视图

```SQL
DROP VIEW viewname;
```

查看视图

```SQL
DESC viewname;
```

#### 初始化数据库环境

右键ViewAndTriggerMainTest.java，选择Edit修改参数为init，初始化数据库环境

![1735-180-2.png](https://doc.shiyanlou.com/courses/1735/1207281/b96e7e82654e43fc0c06df6211c93efc-0)

修改参数为init

![1735-180-3.png](https://doc.shiyanlou.com/courses/1735/1207281/7e210d692333b075bab3d8bc626abbb3-0)

右键ViewAndTriggerMainTest.java，选择Run，运行初始化数据库环境代码

![1735-180-4.png](https://doc.shiyanlou.com/courses/1735/1207281/85a5b06640269cd3054ced44d35e8a27-0)

#### 创建视图

基于数据库表employee，创建视图employee_view，使用create view命令

打开UpdateTest.java，修改第8行内容为

```java
stmt = conn.createStatement();
stmt.executeUpdate("create or replace view employee_view as select * from employee;");
```

右键ViewAndTriggerMainTest.java，修改参数为view

![1735-180-2.png](https://doc.shiyanlou.com/courses/1735/1207281/b96e7e82654e43fc0c06df6211c93efc-0)

修改参数为view

![1735-180-5.png](https://doc.shiyanlou.com/courses/1735/1207281/2e5933775f105ca861e58a54f21e6bf1-0)

右键ViewAndTriggerMainTest，选择Run，运行代码

![1735-180-4.png](https://doc.shiyanlou.com/courses/1735/1207281/85a5b06640269cd3054ced44d35e8a27-0)

#### 查看视图数据

打开QueryTest.java，修改第8行内容为

```java
stmt = conn.createStatement();
String sql = "select * from employee_view";
rs = stmt.executeQuery(sql);
while (rs.next()) {
    for (int i = 1; i <= rs.getMetaData().getColumnCount() ; i++) {
        System.out.print(rs.getString(i)+"\t");
    }
    System.out.println();
}
```

打开ViewAndTriggerMainTest.java修改参数为queryView，运行代码

右键ViewAndTriggerMainTest，选择Run，运行代码

![1735-180-4.png](https://doc.shiyanlou.com/courses/1735/1207281/85a5b06640269cd3054ced44d35e8a27-0)

运行结果为：

​			10001	Georgi	48	
​			10003	Parto	33	
​			10005	Kyoichi	23	
​			10002	Bezalel	21	
​			10004	Chirs	40	
​			10006	Anneke	19	

#### 删除视图

打开UpdateTest.java，修改第8行内容为

```java
stmt = conn.createStatement();
stmt.executeUpdate("drop view employee_view;");
```

右键ViewAndTriggerMainTest，选择Run，运行代码

![1735-180-4.png](https://doc.shiyanlou.com/courses/1735/1207281/85a5b06640269cd3054ced44d35e8a27-0)

## 更新、修改视图

使用上一节的内容重新创建视图employee_view

#### 更新视图

更新修改视图里的记录，利用update命令

打开UpdateTest.java，修改第8行TODO中的内容为

```java
stmt = conn.createStatement();
stmt.executeUpdate("update employee_view set age = 38 where ename = 'Georgi';");
String sql = "select * from employee_view where ename = 'Georgi'";
rs = stmt.executeQuery(sql);
while (rs.next()) {
    for (int i = 1; i <= rs.getMetaData().getColumnCount() ; i++) {
        System.out.print(rs.getString(i)+"\t");
    }
    System.out.println();
}
```

右键ViewAndTriggerMainTest，选择Run，运行代码

结果为：10001	Georgi	38	

使用ALTER语句修改视图，让视图只存储employee表的ename和age字段

打开UpdateTest.java，修改第8行TODO中的内容为

```java
stmt = conn.createStatement();
String sql = "select * from employee_view";
rs = stmt.executeQuery(sql);
while (rs.next()) {
    for (int i = 1; i <= rs.getMetaData().getColumnCount() ; i++) {
        System.out.print(rs.getString(i)+"\t");
    }
    System.out.println();
}
```

右键ViewAndTriggerMainTest，选择Run，运行代码

运行结果

​			10001	Georgi	38	
​			10003	Parto	33	
​			10005	Kyoichi	23	
​			10002	Bezalel	21	
​			10004	Chirs	40	
​			10006	Anneke	19	

## 查询所有视图

打开QueryTest.java，修改第8行内容为

```java
stmt = conn.createStatement();
String sql = "show table status where comment='view';";
rs = stmt.executeQuery(sql);
while (rs.next()) {
    for (int i = 1; i <= rs.getMetaData().getColumnCount() ; i++) {
        System.out.print(rs.getString(i)+"\t");
    }
    System.out.println();
}
```

右键ViewAndTriggerMainTest.java，修改参数为queryView

![1735-180-2.png](https://doc.shiyanlou.com/courses/1735/1207281/b96e7e82654e43fc0c06df6211c93efc-0)

修改参数为queryView

![1735-180-6.png](https://doc.shiyanlou.com/courses/1735/1207281/d8ead77764a56ff698f3631c00a135f8-0)

右键ViewAndTriggerMainTest，选择Run，运行代码

![1735-180-4.png](https://doc.shiyanlou.com/courses/1735/1207281/85a5b06640269cd3054ced44d35e8a27-0)

结果为：employee_view	null	null	null	null	null	null	null	null	null	null	null	null	null	null	null	null	VIEW

## 创建insert触发器

> insert触发器在insert语句执行之前或之后执行。需要知道以下几点：
>
> - 在INSERT触发器代码内，可引用一个名为NEW的虚拟表，访问被插入的行；
> - 在BEFORE INSERT触发器中,NEW中的值也可以被更新（允许更改被插入的值）；
> - 对于AUTO_INCREMENT列，NEW在INSERT执行之前包含0，在INSERT执行之后包含新的自动生成值。

创建一个insert触发器

打开UpdateTest.java，修改第8行TODO中的内容为

```java
stmt = conn.createStatement();
stmt.executeUpdate("create trigger newemployee after insert on employee for each row select 'Employee added' into @result;");
stmt.executeUpdate("insert into employee values(10007,'Bob',22);");
String sql = "select @result;";
rs = stmt.executeQuery(sql);
while (rs.next()) {
    for (int i = 1; i <= rs.getMetaData().getColumnCount() ; i++) {
        System.out.print(rs.getString(i)+"\t");
    }
    System.out.println();
}
```

打开ViewAndTriggerMainTest.java修改参数为trigger，运行代码

运行结果:Employee added	

## 创建update触发器

打开UpdateTest.java，修改第8行TODO中的内容为

```java
stmt = conn.createStatement();
stmt.executeUpdate("create trigger updateemployee before update on employee for each row select 'Employee updated' into @result;");
stmt.executeUpdate("update employee set ename = 'Chiruis' where empno = 10004;");
String sql = "select @result;";
rs = stmt.executeQuery(sql);
while (rs.next()) {
    for (int i = 1; i <= rs.getMetaData().getColumnCount() ; i++) {
        System.out.print(rs.getString(i)+"\t");
    }
    System.out.println();
}
```

右键ViewAndTriggerMainTest.java，修改参数为trigger

![1735-180-2.png](https://doc.shiyanlou.com/courses/1735/1207281/b96e7e82654e43fc0c06df6211c93efc-0)

修改参数为trigger

![1735-180-7.png](https://doc.shiyanlou.com/courses/1735/1207281/59cd2220667e19c0b6c1ab2c42d4fa50-0)

右键ViewAndTriggerMainTest，选择Run，运行代码

![1735-180-4.png](https://doc.shiyanlou.com/courses/1735/1207281/85a5b06640269cd3054ced44d35e8a27-0)

运行结果:Employee updated	

## 创建delete触发器

打开UpdateTest.java，修改第8行TODO中的内容为

```java
stmt = conn.createStatement();
stmt.executeUpdate("create trigger deleteemployee before delete on employee for each row " +
                   "select 'Employee deleted' into @result;");
stmt.executeUpdate("delete from employee where empno = 10007;");
String sql = "select @result;";
rs = stmt.executeQuery(sql);
while (rs.next()) {
    for (int i = 1; i <= rs.getMetaData().getColumnCount() ; i++) {
        System.out.print(rs.getString(i)+"\t");
    }
    System.out.println();
}
```

右键ViewAndTriggerMainTest，选择Run，运行代码

运行结果:Employee deleted	

## 触发器查询、删除

#### 触发器查询

打开QueryTest.java，修改第8行TODO中的内容为

```java
stmt = conn.createStatement();
String sql = "show triggers;";
rs = stmt.executeQuery(sql);
while (rs.next()) {
    for (int i = 1; i <= rs.getMetaData().getColumnCount() ; i++) {
        System.out.print(rs.getString(i)+"\t");
    }
    System.out.println();
}
```

右键ViewAndTriggerMainTest.java，修改参数为queryTrigger

![1735-180-2.png](https://doc.shiyanlou.com/courses/1735/1207281/b96e7e82654e43fc0c06df6211c93efc-0)

修改参数为queryTrigger

![1735-180-8.png](https://doc.shiyanlou.com/courses/1735/1207281/0d1d162e6a62cf6ed0770a6da3daf345-0)

右键ViewAndTriggerMainTest，选择Run，运行代码

![1735-180-4.png](https://doc.shiyanlou.com/courses/1735/1207281/85a5b06640269cd3054ced44d35e8a27-0)

#### 触发器删除

打开UpdateTest.java，修改第8行TODO中的内容为

```java
stmt = conn.createStatement();
stmt.executeUpdate("drop trigger updateemployee;");
String sql = "show triggers;";
rs = stmt.executeQuery(sql);
while (rs.next()) {
    for (int i = 1; i <= rs.getMetaData().getColumnCount() ; i++) {
        System.out.print(rs.getString(i)+"\t");
    }
    System.out.println();
}
```

右键ViewAndTriggerMainTest.java，修改参数为trigger

![1735-180-2.png](https://doc.shiyanlou.com/courses/1735/1207281/b96e7e82654e43fc0c06df6211c93efc-0)

修改参数为trigger

![1586858934769](C:\Users\ChengYueyi\AppData\Roaming\Typora\typora-user-images\1586858934769.png)

右键ViewAndTriggerMainTest，选择Run，运行代码

![1735-180-4.png](https://doc.shiyanlou.com/courses/1735/1207281/85a5b06640269cd3054ced44d35e8a27-0)



