---
show: step
version: 1.0 
---

## 课程介绍

本课程将带领您在已经部署 SequoiaDB 巨杉数据库引擎及创建了 SequoiaSQL-MySQL 实例的环境中，学习存储过程和函数。

#### 请点击右侧选择使用的实验环境

#### 部署架构：

本课程中 SequoiaDB 巨杉数据库的集群拓扑结构为三分区单副本，其中包括：1个 SequoiaSQL-MySQL 数据库实例节点、1个引擎协调节点，1个编目节点与3个数据节点。

![图片描述](https://doc.shiyanlou.com/courses/1469/1207281/8d88e6faed223a26fcdc66fa2ef8d3c5)

详细了解 SequoiaDB 巨杉数据库系统架构：

- [SequoiaDB 系统架构](http://doc.sequoiadb.com/cn/sequoiadb-cat_id-1519649201-edition_id-0)

#### 实验环境

课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎以及 SequoiaSQL-MySQL 实例均为 3.4 版本。

#### 课程概述

**存储过程**

存储过程（Stored Procedure）是一种在数据库中存储复杂程序，以便外部程序调用的一种数据库对象。

存储过程是为了完成特定功能的 SQL 语句集，经编译创建并保存在数据库中，用户可通过指定存储过程的名字并给定参数(需要时)来调用执行。

**函数**

函数存储着一系列 SQL 语句，调用函数就是一次性执行这些语句。所以函数可以降低语句重复。

## 打开项目

#### 打开idea

打开 idea 代码开发工具

![1735-110-1.png](https://doc.shiyanlou.com/courses/1735/1207281/6f87a8c93937c3c51f6d4839559de710-0)

#### 打开SSQL-MySQL项目

打开 SSQL-MySQL 项目，在该课程中完成后续试验

![1735-110-13.png](https://doc.shiyanlou.com/courses/1735/1207281/40a9e7b6fbd5c3853dc09f69d0a06c86-0)

#### 打开lesson9_procedure包

打开 lesson9_procedurepackge，在该 packge 中完成后续课程

![1735-190-1.png](https://doc.shiyanlou.com/courses/1735/1207281/34390ccd3dd5bf6284931f653e14f04b-0)

## 创建无参数存储过程

#### 存储过程的优点

- 存储过程可封装，并隐藏复杂的商业逻辑。
- 存储过程可以回传值，并可以接受参数。
- 存储过程无法使用 SELECT 指令来运行，因为它是子程序，与查看表，数据表或用户定义函数不同。
- 存储过程可以用在数据检验，强制实行商业逻辑等。

#### 开始创建无参数存储过程

1）打开 ProcefureTest.java
2）修改 createProcedure1 方法的 TODO code 1中代码为

```java
//创建一个 Statement 对象来将 SQL 语句发送到数据库
stmt = conn.createStatement();
//编写 sql 创建无参数存储过程
String sql = "CREATE PROCEDURE avgAge()" +
    "BEGIN" +
    "SELECT AVG(age) AS avgAge " +
    "FROM employee;" +
    "END";
stmt.executeUpdate(sql);
```

3）修改参数，右键 ProcedureMainTest.java，选择 Edit 'ProcedureMainT...main()'

![1735-190-2.png](https://doc.shiyanlou.com/courses/1735/1207281/351b9030a7157bee82c38ff638eee318-0)

4）修改参数为 procedure1
5）执行代码，右键 ProcedureMainTest.java，选择 Run 'ProcedureMainT...main()'，运行代码

![1735-190-4.png](https://doc.shiyanlou.com/courses/1735/1207281/e512acbcde1be576a11748cb924a8d2f-0)

6）查看结果

## 创建有参数存储过程

MySQL 支持 IN （传递给存储过程）、OUT (从存储过程传出)和 INOUT (对存储过程传入和传出)类型的参数。

1）打开 ProcefureTest.java
2）修改 createProcedure2 方法的 TODO code 2中代码为

```java
//创建一个 Statement 对象来将 SQL 语句发送到数据库
stmt = conn.createStatement();
//编写 sql 创建有参数存储过程
String sql = "CREATE PROCEDURE getName(" +
    "IN ino INT," +
    "OUT oname VARCHAR(32)" +
    ")" +
    "BEGIN" +
    "SELECT ename FROM employee WHERE empno = ino INTO oname;" +
    "END";
stmt.executeUpdate(sql);
```

3）修改参数，右键 ProcedureMainTest.java，选择 Edit 'ProcedureMainT...main()'

![1735-190-2.png](https://doc.shiyanlou.com/courses/1735/1207281/351b9030a7157bee82c38ff638eee318-0)

4）修改参数为 procedure2
5）执行代码，右键 ProcedureMainTest.java，选择 Run 'ProcedureMainT...main()'，运行代码

![1735-190-4.png](https://doc.shiyanlou.com/courses/1735/1207281/e512acbcde1be576a11748cb924a8d2f-0)

6）查看结果

## 调用、删除存储过程

#### 调用存储过程

1）打开 ProcefureTest.java
2）修改 callProcedure 方法的 TODO code 3中代码为

```java
//调用数据库存储过程
CallableStatement clbStmt = conn.prepareCall("{CALL avgAge()}");
//执行调用
rs = clbStmt.executeQuery();
while (rs.next()) {
	for (int i = 1; i <= rs.getMetaData().getColumnCount(); i++) {
		System.out.print(rs.getString(i)+"\t");
	}
	System.out.println();
}
```

3）修改参数，右键 ProcedureMainTest.java，选择 Edit 'ProcedureMainT...main()'

![1735-190-2.png](https://doc.shiyanlou.com/courses/1735/1207281/351b9030a7157bee82c38ff638eee318-0)

4）修改参数为 callProcedure
5）执行代码，右键 ProcedureMainTest.java，选择 Run 'ProcedureMainT...main()'，运行代码

![1735-190-4.png](https://doc.shiyanlou.com/courses/1735/1207281/e512acbcde1be576a11748cb924a8d2f-0)

6）查看结果

结果为：30.6667	

#### 删除存储过程

1）打开 ProcefureTest.java
2）修改 callProcedure 方法的 TODO code 4中代码为

```java
//创建一个 Statement 对象来将 SQL 语句发送到数据库
stmt = conn.createStatement();
//编写 sql 删除存储过程
String sql = "DROP PROCEDURE avgAge;";
stmt.executeUpdate(sql);
```

3）修改参数，右键 ProcedureMainTest.java，选择 Edit 'ProcedureMainT...main()'

![1735-190-2.png](https://doc.shiyanlou.com/courses/1735/1207281/351b9030a7157bee82c38ff638eee318-0)

4）修改参数为 dropProcedure
5）执行代码，右键 ProcedureMainTest.java，选择 Run 'ProcedureMainT...main()'，运行代码

![1735-190-4.png](https://doc.shiyanlou.com/courses/1735/1207281/e512acbcde1be576a11748cb924a8d2f-0)

6）查看结果

## 函数的创建和删除

#### 创建自定义函数

1）打开 FunctionTest.java
2）修改 createFunction 方法的 TODO code 1中代码为

```java
//创建一个 Statement 对象来将 SQL 语句发送到数据库
stmt = conn.createStatement();
//编写 sql 创建自定义函数
String sql = "CREATE FUNCTION createTable(name VARCHAR(20)) RETURNS VARCHAR(50)" +
    "BEGIN" +
    "DECLARE str VARCHAR(50) DEFAULT '';" +
    "SET @tableName=name;" +
    "SET str=CONCAT('CREATE TABLE ',@tableName,'(id INT,name VARCHAR(20));');" +
    "RETURN str;" +
    "END";
stmt.executeUpdate(sql);
```

3）修改参数，右键 ProcedureMainTest.java，选择 Edit 'ProcedureMainT...main()'

![1735-190-2.png](https://doc.shiyanlou.com/courses/1735/1207281/351b9030a7157bee82c38ff638eee318-0)

4）修改参数为 createFunction
5）执行代码，右键 ProcedureMainTest.java，选择 Run 'ProcedureMainT...main()'，运行代码

![1735-190-4.png](https://doc.shiyanlou.com/courses/1735/1207281/e512acbcde1be576a11748cb924a8d2f-0)

6）查看结果

#### 删除自定义函数

1）打开 FunctionTest.java
2）修改 dropFunction 方法的 TODO code 2中代码为

```java
//创建一个 Statement 对象来将 SQL 语句发送到数据库
stmt = conn.createStatement();
//编写 sql 删除自定义函数
String sql = "DROP FUNCTION IF EXISTS createTable;";
stmt.executeUpdate(sql);
```

3）修改参数，右键 ProcedureMainTest.java，选择 Edit 'ProcedureMainT...main()'

![1735-190-2.png](https://doc.shiyanlou.com/courses/1735/1207281/351b9030a7157bee82c38ff638eee318-0)

4）修改参数为 dropFunction
5）执行代码，右键 ProcedureMainTest.java，选择 Run 'ProcedureMainT...main()'，运行代码

![1735-190-4.png](https://doc.shiyanlou.com/courses/1735/1207281/e512acbcde1be576a11748cb924a8d2f-0)

6）查看结果

