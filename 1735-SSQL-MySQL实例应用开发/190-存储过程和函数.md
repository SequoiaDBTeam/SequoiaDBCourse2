---
show: step
version: 1.0 

---

## 课程介绍

本课程将带领您在已经部署 SequoiaDB 巨杉数据库引擎及创建了 MySQL 实例的环境中，学习存储过程和函数

#### 请点击右侧选择使用的实验环境

#### 实验环境

课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎以及 SequoiaSQL-MySQL 实例均为 3.4 版本。

#### 课程概述

**存储过程**

什么是存储过程？

存储过程可以说是一个记录集吧，它是由一些T-SQL语句组成的代码块，这些T-SQL语句代码像一个方法一样实现一些功能（对单表或多表的增删改查），然后再给这个代码块取一个名字，在用到这个功能的时候调用他就行了。

**函数**

函数存储着一系列sql语句，调用函数就是一次性执行这些语句。所以函数可以降低语句重复。【但注意的是函数注重返回值，不注重执行过程，所以一些语句无法执行。所以函数并不是单纯的sql语句集合。】

## 打开项目

#### 打开idea

打开idea代码开发工具

![1735-110-1.png](https://doc.shiyanlou.com/courses/1735/1207281/6f87a8c93937c3c51f6d4839559de710-0)

#### 打开SSQL-MySQL项目

打开SSQL-MySQL项目，在该课程中完成后续试验

![1735-110-13.png](https://doc.shiyanlou.com/courses/1735/1207281/40a9e7b6fbd5c3853dc09f69d0a06c86-0)

#### 打开lesson9_procedure包

打开lesson9_procedurepackge，在该packge中完成后续课程。

![1735-190-1.png](https://doc.shiyanlou.com/courses/1735/1207281/34390ccd3dd5bf6284931f653e14f04b-0)

## 创建无参数存储过程

#### 存储过程的优点

1.由于数据库执行动作时，是先编译后执行的。然而存储过程是一个编译过的代码块，所以执行效率要比T-SQL语句高。

2.一个存储过程在程序在网络中交互时可以替代大堆的T-SQL语句，所以也能降低网络的通信量，提高通信速率。

3.通过存储过程能够使没有权限的用户在控制之下间接地存取数据库，从而确保数据的安全

#### 初始化数据库环境

右键ProcedureMainTest，选择Edit修改参数为init，初始化数据库环境

![1735-190-2.png](https://doc.shiyanlou.com/courses/1735/1207281/351b9030a7157bee82c38ff638eee318-0)

![1735-190-3.png](https://doc.shiyanlou.com/courses/1735/1207281/5090672333b782cea26a55bf57b4494a-0)

右键TableAndIndexMainTest.java，选择Run，运行初始化数据库环境代码

![1735-190-4.png](https://doc.shiyanlou.com/courses/1735/1207281/e512acbcde1be576a11748cb924a8d2f-0)

#### 开始创建无参数存储过程

打开UpdateTest.java，修改第8行TODO中的内容为

```java
stmt = conn.createStatement();
String sql = "create procedure avgAge()\n" +
    "begin\n" +
    "\tselect avg(age) as avgAge \n" +
    "\tfrom employee;\n" +
    "end";
stmt.executeUpdate(sql);
```

右键ProcedureMainTest，选择Edit，修改参数为procedure，

![1735-190-2.png](https://doc.shiyanlou.com/courses/1735/1207281/351b9030a7157bee82c38ff638eee318-0)

![1735-190-5.png](https://doc.shiyanlou.com/courses/1735/1207281/f0a3e5ed88d982982a624082421ea7ac-0)

右键ProcedureMainTest，选择Run，运行代码

![1735-190-4.png](https://doc.shiyanlou.com/courses/1735/1207281/e512acbcde1be576a11748cb924a8d2f-0)

## 创建有参数存储过程

> MySQL支持IN（传递给存储过程）、OUT(从存储过程传出)和INOUT(对存储过程传入和传出)类型的参数。

打开UpdateTest.java，修改第8行TODO中的内容为

```java
stmt = conn.createStatement();
String sql = "create procedure getName(\n" +
    "\tIN ino int,\n" +
    "\tOUT oname varchar(32)\n" +
    ")\n" +
    "begin\n" +
    "\tselect ename from employee where empno = ino into oname; \n" +
    "end\n";
stmt.executeUpdate(sql);
```

右键ProcedureMainTest，选择Run，运行代码

![1735-190-4.png](https://doc.shiyanlou.com/courses/1735/1207281/e512acbcde1be576a11748cb924a8d2f-0)

## 调用、检查、删除存储过程

#### 调用存储过程

打开UpdateTest.java，修改第8行TODO中的内容为

```java
CallableStatement clbStmt = conn.prepareCall("{CALL avgAge()}");
rs = clbStmt.executeQuery();
while (rs.next()) {
	for (int i = 1; i <= rs.getMetaData().getColumnCount(); i++) {
		System.out.print(rs.getString(i)+"\t");
	}
	System.out.println();
}
```

右键ProcedureMainTest，选择Run，运行代码

![1735-190-4.png](https://doc.shiyanlou.com/courses/1735/1207281/e512acbcde1be576a11748cb924a8d2f-0)

结果为：30.6667	

#### 检查存储过程

打开UpdateTest.java，修改第8行TODO中的内容为

```java
CallableStatement clbStmt = conn.prepareCall("{CALL avgAge()}");
rs = clbStmt.executeQuery();
while (rs.next()) {
	for (int i = 1; i <= rs.getMetaData().getColumnCount(); i++) {
		System.out.print(rs.getString(i)+"\t");
	}
	System.out.println();
}
```

右键ProcedureMainTest，选择Run，运行代码

![1735-190-4.png](https://doc.shiyanlou.com/courses/1735/1207281/e512acbcde1be576a11748cb924a8d2f-0)

#### 删除存储过程

打开UpdateTest.java，修改第8行TODO中的内容为

```java
stmt = conn.createStatement();
String sql = "drop procedure avgAge;";
stmt.executeUpdate(sql);
```

右键ProcedureMainTest，选择Run，运行代码

![1735-190-4.png](https://doc.shiyanlou.com/courses/1735/1207281/e512acbcde1be576a11748cb924a8d2f-0)

## 函数的创建和删除

#### 创建自定义函数

打开UpdateTest.java，修改第8行TODO中的内容为

```java
stmt = conn.createStatement();
String sql = "create function createTable(name varchar(20)) returns varchar(50)\n" +
    "begin\n" +
    "\tdeclare str varchar(50) default '';\n" +
    "\tset @tableName=name;\n" +
    "\tset str=concat('create table ',@tableName,'(id int,name varchar(20));');\n" +
    "\treturn str;\n" +
    "end \n";
stmt.executeUpdate(sql);
```

右键ProcedureMainTest，选择Run，运行代码

![1735-190-4.png](https://doc.shiyanlou.com/courses/1735/1207281/e512acbcde1be576a11748cb924a8d2f-0)

#### 删除自定义函数

打开UpdateTest.java，修改第8行TODO中的内容为

```java
stmt = conn.createStatement();
String sql = "drop function if exists createTable;";
stmt.executeUpdate(sql);
```

右键ProcedureMainTest，选择Run，运行代码

![1735-190-4.png](https://doc.shiyanlou.com/courses/1735/1207281/e512acbcde1be576a11748cb924a8d2f-0)
