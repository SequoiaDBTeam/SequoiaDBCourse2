---
show: step
version: 1.0

---

## 课程介绍

本课程将介绍在 Java 开发环境下如何对 SequoiaDB 数据库 JSON 实例中的集合进行分区。

#### JSON 开发简介

SequoiaDB 巨杉数据库为应用提供通过 SDK 驱动进行数据库操作和集群操作的接口。

#### 实验流程简述

- 用户通过 IDEA 编辑器编写 Java 源码
- 实验相关核心代码，可从文档中的代码示例粘贴到项目指定文件的 TODO 标记处
- 通过编译、运行 Java 代码，操作 SequoiaDB 数据库 JSON 实例

![](https://doc.shiyanlou.com/courses/1736/1207281/7b1731fc121e3b460dcd9841eb0218a6-0)

#### 实验环境

课程使用的实验环境为 Ubuntu Linux 16.04 64 位版本。SequoiaDB 数据库引擎为 3.4 版本。IDEA 编辑器为 16.0 版本。JDK 为 1.8 版本。

## 打开项目

#### 打开 IDEA

打开 IDEA 代码开发工具。

![](https://doc.shiyanlou.com/courses/1736/1207281/06650396616c742995bb63fcf933fac5-0)

#### 打开项目

打开指定项目，在该项目中完成所有实验步骤。

![](https://doc.shiyanlou.com/courses/1736/1207281/9f17386c8098e8f4e46634f208fcd36b-0)

#### 打开 Package

打开指定的 Package，在该 Package 中完成后续课程。

![](https://doc.shiyanlou.com/courses/1736/1207281/cf8b0700bc40d2f220cb73f9f39700cd-0)

## 水平分区

#### 概述

水平分区可以将一张表的数据散落到多个数据组中去。

#### 操作步骤

打开指定的 Java 源文件。

![](https://doc.shiyanlou.com/courses/1736/1207281/0ed83b48c2bf3e62388a2e0135d17857-0)

复制以下代码样例。

```java
// 创建一个employee的集合
BSONObject options = new BasicBSONObject();
BasicBSONObject shardingKey = new BasicBSONObject();
// 以age字段作为分区键
shardingKey.put("age", 1);
options.put("ShardingKey", shardingKey);
// 设置集合的一致性
options.put("ReplSize", 1);
// 设置分区类型
options.put("ShardingType", "hash");
// 分区数。仅当选择 hash 分区时填写，代表了 hash 分区的个数。
// 其值必须是2的幂。范围在[2^3，2^20]。默认为4096
options.put("Partition", 4096);
// 标示新集合是否开启自动切分功能，默认为 false
options.put("AutoSplit", true);
// 标示新集合是否开启数据压缩功能，默认为 true
options.put("Compressed", true);
// 压缩算法类型。默认为 lzw 算法。其可选取值如下：
//"snappy"：使用 snappy 算法压缩。
//"lzw"：使用 lzw 算法压缩。
options.put("CompressionType", "lzw");
cs.createCollection("employee", options);
```

将代码样例粘贴到第 37 行的 TODO ~ TODO END 位置区间内。

![// TODO 贴图](https://doc.shiyanlou.com/courses/1736/1207281/59a894da9149e308f4dcf0d0cba52470-0)

右键点击 PartitionMainTest 类，创建/编辑主类运行环境。

![](https://doc.shiyanlou.com/courses/1736/1207281/278866f798cc5c4e85448e2e7c0b440f-0)

配置 Configuration 页中的 Program arguments 选项，写入指定的参数，点击”OK“。

![// TODO 贴图](https://doc.shiyanlou.com/courses/1736/1207281/4d4217cc728197b5bec8e288f0b311c2-0) 

右键点击 PartitionMainTest 类，运行主程序。

![](https://doc.shiyanlou.com/courses/1736/1207281/5cfa14db36749e15b9062d66c5559ff4-0)

在 IDEA 输出窗口查看运行效果。

![// TODO 贴图](https://doc.shiyanlou.com/courses/1736/1207281/cd6f31fc46502a9df479ec4fa510f1da-0)

双击放大控制台输出窗口，查看详细输出信息。

![](https://doc.shiyanlou.com/courses/1736/1207281/0d88bb1f1d4bdeab40e4b74755853d5b-0)

通过输出信息，可以看到创建集合的详细信息，包括了涉及数据组分区的情况。

## 垂直分区（主子表）

#### 概述

垂直分区可以将一张表查分成多个子表，对外提供的入口还是这张主表。

#### 操作步骤

打开指定的 Java 源文件。

![](https://doc.shiyanlou.com/courses/1736/1207281/88e14a9d3e73b76d88c849134f4ed13a-0)

复制以下代码样例。

```java
// 创建一个employeeMain的集合（主表）
BSONObject optionsMain = new BasicBSONObject();
BasicBSONObject shardingKeyMain = new BasicBSONObject();
// 将部门编号设置为分区键
shardingKeyMain.put("deptno", 1);
optionsMain.put("ShardingKey", shardingKeyMain);
// 分区类型为范围分区
optionsMain.put("ShardingType", "range");
// 标记为主表
optionsMain.put("IsMainCL", true);
DBCollection employeeMain = cs.createCollection("employee", optionsMain);
// 创建一个employee201（子表，以部门编号201作为分区范围）
// note：在某些表设计中，我们也可以用月份或年份作为分区范围
BSONObject options201 = new BasicBSONObject();
// 设置子表属性。子表也可为分区表。
BasicBSONObject shardingKey201 = new BasicBSONObject();
shardingKey201.put("age", 1);
options201.put("ShardingKey", shardingKey201);
options201.put("ReplSize", 1);
options201.put("ShardingType", "hash");
options201.put("Partition", 4096);
options201.put("AutoSplit", true);
options201.put("Compressed", true);
options201.put("CompressionType", "lzw");
cs.createCollection("employee201", options201);
// 将子表添加到主表上去
BSONObject bound = (BSONObject) org.bson.util.JSON.parse("{'LowBound':{'deptno':201}}");
// 指定要添加的子表所属范围的边界值
// bound:每一个分区区间为左闭右开规则，即 [201, 202)
bound.putAll((BSONObject) org.bson.util.JSON.parse("{'UpBound':{'deptno':202}}"));
// 添加子表
employeeMain.attachCollection("company.employee201", bound);
employeeMain.insert("{ \"empno\": 10002, \"deptno\": 201, \"ename\": " +
                    "\"Bezalel\", \"age\": 21 }");
```

将代码样例粘贴到第 36 行的 TODO ~ TODO END 位置区间内。

![// TODO 贴图](https://doc.shiyanlou.com/courses/1736/1207281/71575ec31af0cd190d8e4335b6605441-0)

右键点击 PartitionMainTest 类，创建/编辑主类运行环境。

![](https://doc.shiyanlou.com/courses/1736/1207281/278866f798cc5c4e85448e2e7c0b440f-0)

配置 Configuration 页中的 Program arguments 选项，写入指定的参数，点击”OK“。

![// TODO 贴图](https://doc.shiyanlou.com/courses/1736/1207281/e90c5a16997947877d90dc48958577f2-0) 

右键点击 PartitionMainTest 类，运行主程序。

![](https://doc.shiyanlou.com/courses/1736/1207281/5cfa14db36749e15b9062d66c5559ff4-0)

在 IDEA 输出窗口查看运行效果。

![// TODO 贴图](https://doc.shiyanlou.com/courses/1736/1207281/cd6f31fc46502a9df479ec4fa510f1da-0)

双击放大控制台输出窗口，查看详细输出信息。

![](https://doc.shiyanlou.com/courses/1736/1207281/01c7f6fc1606b6c9553a5a95a0145467-0)

通过输出信息，可以看到成功创建了一张主子表（垂直分区）。



## 总结

本课程介绍了 Java 开发环境下如何对 SequoiaDB 数据库 JSON 实例中的集合进行分区。
